---
slug: 如何构建领域模型
title: 如何构建领域模型
author: Jessie
author_title: 后端开发
author_url: https://github.com/OnfireMrHuang
author_image_url: https://avatars.githubusercontent.com/u/22336719?v=4
tags: [Golang, Rust, kubernetes, spark, Java]
---

构建领域模型的核心就是事件风暴,事件风暴是一项团队活动，领域专家与项目团队通过头脑风暴的形式，罗列出领域中所有的领域事件，整合之后形成最终的领域事件集合，然后对每一个事件，标注出导致该事件的命令，再为每一个事件标注出命令发起方的角色。命令可以是用户发起，也可以是第三方系统调用或者定时器触发等，最后对事件进行分类，整理出实体、聚合、聚合根以及限界上下文。

**那么如何用事件风暴构建领域模型？**

构建领域模型的步骤主要如下:

- 产品愿景
- 业务场景分析
- 领域建模
- 微服务拆分

## 产品愿景

产品愿景的主要目的是对产品顶层价值的设计，使产品目标用户、核心价值、差异化竞争点等信息达成一致，避免产品偏离方向。
核心就是描述清楚背景，即：

1、我们这个产品是为了做什么？

2、这个产品的目标客户是谁？

3、同类产品的现状如何、我们有什么优势？

4、我们是否抓住了用户痛点。。。。，吧啦吧啦

## 业务场景分析

主要是从用户视角出发，根据业务流程、场景分析。

### 业务场景分析的参与者

核心是领域专家, 另外还可以聚集DDD专家、架构师、产品经理、项目经理、开发人员、测试人员一起，起点可以就是业务分析会。

### 业务场景分析的材料

可以准备贴纸和水笔，比如先定义命令、实体、领域事件、补充信息四个域，然后收集大家的想法，罗列后把对应的信息挂在各自的域中。这四个域核心关联就是某领域时间是由哪个实体行使了什么命令发生的。

### 业务场景分析的关注点

分析业务的时候，主要分析业务的语言和行为。比如某个业务动作触发了下一个业务动作，这个动作的输入、输出是什么？是谁触发的动作，动作内容是什么。这样便可以将业务动作归到事件、动作内容归到命令、动作的生成主体归到实体。

### 用户中台举例

用户中心业务场景有如下:

- 系统岗位的菜单权限设置，管理岗拥有那些菜单栏，开发岗用户哪些菜单栏？
- 用户权限设置，用户建立账户和密码（注册还是分配），用户的岗位（系统管理员？）
- 用户登录系统和权限校验，生成日志？

按照上面的业务流程，列举出下面这些领域事件:

![domain_analysis](https://static001.geekbang.org/resource/image/e2/e4/e2f91189e25bbaa81307d1fea694aee4.jpg)

## 领域建模

得到领域事件和命令后，我们就可以提取产生这些行为的实体。如下图：

![entity](https://static001.geekbang.org/resource/image/cf/fd/cf35a9437319169784db9e5aab97b1fd.jpg)

得到实体之后就是找出聚合根，我们先一个实体一个聚合根，分为7个聚合根；然后查看是否有可能合并的实体，比如系统和菜单两个实体同属于系统功能，可以合并为一个系统功能聚合根。接着再把聚合根和它关联的实体和值对象组合成为聚合，于是就有了系统功能、岗位、用户信息、用户日志、账户和认证票据六个聚合。

有了聚合之后呢，我们还需要划分限界上下文。根据用户域的上下文语境，可以吧用户信息、用户日志聚合起来，其他的以此类推，聚合如下:

![aggra](https://static001.geekbang.org/resource/image/d0/e1/d0191d4e4c51ff91dc830bf38c0e7ae1.jpg)

上图我们就得到了具体的领域模型了。

## 微服务拆分

微服务的设计还需要考虑服务的粒度、分层、边界划分、依赖关系和集成关系。除了考虑业务职责单一外，我们还需要考虑将敏态与稳态业务的分离、非功能性需求（如弹性伸缩要求、安全性等要求）、团队组织和沟通效率、软件包大小以及技术异构等非业务因素。

将领域模型和微服务结合落地我们再下一篇会继续说明...
