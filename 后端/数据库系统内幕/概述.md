# 概述

数据库的一些应用场景:

1. 用于临时热数据
2. 用于长期冷数据的存储
3. 用于复杂的分析查询
4. 只允许键值访问
5. 专用于存储时间序列化数据进行优化
6. 用于高效地存储二进制大对象

正是这些不同场景的诉求，所以才衍生出了各种各样的数据库系统，比如键值存储型、关系型、面向文档型、图数据等等。另外一些人还将数据库分为了三大类: OLTP(联机事务处理)数据库、OLAP(联机分析处理数据库)、HTAP(混合事务和分析处理数据库)。要理解数据库系统，我们需要先重点了解存储和索引结构，需要理解高层次的数据组织方法以及数据和索引文件两者之间的关系；另外在存储层，我们可以深入了解广泛用于开发高效存储结构的技术，以及这些技术的应用是如何去影响它们的设计和实现的。

### 数据库架构

![Untitled](%E6%A6%82%E8%BF%B0/Untitled.png)

- 传输模块
    - 数据库系统常使用客户端/服务器模型, 同时传输系统也负责数据库集群中其他节点的通信
    - 传输模型通常又包括传输协议、传输安全、并发模型以及连接管理。
- 查询处理器
    - 查询解析器
        - 对接收到的查询进行词法解析、语法解析和验证、访问控制检查，然后传递解析后的查询给到优化器
    - 查询优化器
        - 消除查询中不可能执行到的部分和冗余部分
        - 根据内部统计信息和数据分布尝试找到查询最高效的方法
        - 最后得到执行计划
- 执行引擎
    - 执行计划由执行引擎处理，根据执行计划可能涉及本地和远程操作，远程操作则涉及向集群中其他节点写、读、复制数据，本地操作就向下到存储引擎执行
- 存储引擎
    - 事务管理器
        - 调度事务，确保不会使数据库响应用于请求时处于逻辑不一致的状态
    - 锁管理器
        - 锁管理器为正在运行的事务锁定数据库对象，确保并发操作不会破环物理数据的完整性。锁管理器和上面的事务管理器共同负责并发控制，保证数据的逻辑和物理完整性的同时，确保尽可能高效地执行并发操作。
    - 访问方法(存储结构)
        - 管理数据在磁盘上的数据访问并负责组织磁盘上的数据。访问对象通常包含堆文件和存储结构文件(如B树、LSM树)。
    - 缓冲区管理器
        - 缓冲区管理器将数据页级存在内存中
    - 恢复管理器
        - 恢复管理器维护操作日志井在出现故陪时还原系统状态

### 内存与磁盘

- 内存数据库
    - 主要将数据存储在内存中，并使用磁盘进行数据恢复和日志记录
- 磁盘数据库
    - 大部分数据都保存在磁盘上，使用内存来缓存磁盘内容或作为临时存储。
- 对比
    - 内存数据库不但存储介质不同于磁盘数据库，而且数据结构、数据组织和优化的技术也不同
    - 内存数据库的优势是性能、编程简单(操作系统抽象了内存管理，允许我们从分配和释放任意大小的内存块角度进行思考，但是磁盘则需要我们手动管理数据引用、序列化格式、释放的空间和碎片)
    - 磁盘数据库的优势是持久性以及成本。

### 面向行和面向列

**1、面向行的数据布局**

行布局非常接近表格的数据表示方法，即每一行都具有相同的字段集合。在需要按行访问数据的情况下，面向行的存储最有用，将整行存储在一起可以提高空间局部性；缺点也很明显，当仅需要访问多个记录某个字段的查询时开销更大，因为其他字段数据在这个过程中也会被读入；所以适合OLTP场景。

**2、面向列的数据布局**

对数据进行垂直分区，同一列的值被连续地存储在磁盘上。面向列的存储非常适合计算聚合分析型工作负载，例如查找趋势、计算平均值等，即OLAP场景。

面向列的文件格式: Apache Parquet、Apache ORC、RCFile

面向列的存储: Apache Kudu、ClickHouse

**3、区别和优化**

1. 在一次读取中，从同一列中读取多个值可以显著提高缓存利用率和计算效率，在现代CPU上，向量化指令可以使单条CPU指令一次处理多个数据点。
2. 将具有相同数据类型的值存储在一起，可以提高压缩率，我们可以根据不同的数据类型使用不同的压缩算法，并为每中情况选择最有效的压缩方法。
3. 要决定使用面向行还是面向列，需要了解访问模式，如果大多数或所有列都是需要的，工作负载主要由单条记录查询和范围扫描组成，则面向行存储可能更好；如果扫描跨越多行，或者在列的子集上进行计算聚合，则使用面向列可能更好。

**4、宽列式存储**

面向列数据库不能等同于宽列式存储(如BigTable或HBase)，在宽列式数据库中，数据表示为多维映射，列被分组为列族，并且在每个列族中，数据被逐行存储。该布局适合存储由一个键或一组键直接来检索的数据，与KV键值数据库场景类似.

### 数据文件和索引文件

数据文件存储数据记录，索引文件存储元数据并使用它来定位数据文件中的记录。

- 数据文件(primary file)
    - 索引组织表实现
        - 索引组织表将数据存储在索引自身，由于记录是按键的顺序存储的，所以索引组织表中的范围扫描可以通过顺序扫描其内容来实现。
    - 堆组织表实现
        - 不需要遵循任何特定顺序，大多数情况都是按写顺序放置的，需要额外的索引结构来指向存储数据，使其能够被检索到
    - 哈希组织表实现
        - 记录存储在桶中，通过键的哈希值确定记录属于哪个桶！ 记录在桶中可以按追加顺序，也可以按键排序存储来提高查询速度。
- 索引文件
    - 索引是一种为了高效检索数据而对磁盘上的数据记录进行组织的结构。
    - 数据文件上的索引称为主索引，但是大多数情况下，我们还可以假设主索引是在主键或作为主键的一组键之上构建的，所有其他索引都称为二级索引。
    - 如果数据记录的顺序遵循搜索键顺序，则这种索引称为聚簇索引。聚簇索引中的数据记录通常与索引存储于同一文件，有时也存放在单独的聚簇文件中。如果数据存储在单独的文件中，且顺序不遵循键顺序，则索引称为非聚簇索引。

### 缓冲、不可变性和有序性

存储结构有三个常见变量: 是否使用缓冲、使用不可变还是可变的文件、是否按顺序存储值。

**缓冲** 

缓冲定义了存储结构在将数据放入磁盘之前是否选择在内存中保留一定数量的数据。

**可变性(或不可变性)**

可变性定义了存储结构是否可以在文件的同一位置读取文件的某些部分、更新它们并将更新的结果写入文件。不可变结构则是只可追加的，写入后不修改文件内容，而是将修改附加到文件的末尾。另外还有其他方法来实现不可变性，比如写时复制，其中持有更新记录的页会被写入文件中的新位置。LSM树和B树之间的区别就是数据的不可变还是原地更新的。

**有序性**

有序性定义为数据记录是否按键顺序存储在磁盘上的页中。换句话说，紧密排序的键存储在磁盘上的连续段中。有序性常常决定了我们能否有效地扫描记录的范围，而不仅仅是定位单个数据记录。无序存储数据的方式对于某些写入时的优化提供了可能性。