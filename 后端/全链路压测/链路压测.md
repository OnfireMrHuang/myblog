# 链路压测

## 前言

---

本章博客是学习高楼老师的全链路压测30讲后的个人总结文章。分为了几个板块：

1. 前期准备: 介绍RESAR性能工程思维模型, 说明全链路压测在其中的位置关系，为全链路压测做理论说明，同时也介绍了启动全链路压测的一些必要条件。
2. 全链路压测方案: 介绍全链路压测的整体方法并展开进行了解读。
3. 系统改造: 为了落地方案，需要对压测的目标系统做相应的改造，这篇主要描述了需要改造的系统组件以及实践方案。
4. 压测平台: 为了后续的性能压测，我们还需要有一套流量回放工具、监控分析工具等辅助工具支撑，它们共同组成了一套压测平台
5. 性能场景: 再然后就是执行压测工作了, 本篇主要介绍了基准场景、容量场景、稳定性场景和异常场景的背景和执行工作。
6. 结果&报告输出: 输出详细的测试报告，对应测试目标是否达成、系统性能水位和统计数据、调优手段记录等等。

## 前期准备

---

<font color=Coral size=4>RESAR性能工程</font>

![工程实践方法](./链路压测/链路压测.png)

上面是做性能工程的一个大致模型,我们可以看到这个模型覆盖了需求、模型、监控、分析;这是一个完整的工程，涉及人员有管理层、产品、开发、测试、运维，同时压测还涉及到环境搭建、系统改造、监控体系打造等工作，成本不可谓不高。全链路压测的模型可以理解为是该模型的一个具体的项目实践，所以在启动全链路压测之前，一定要根据自身的业务系统评估好价值，不然还未开始就已经注定失败了。

**全链路压测的目标(强调):**

1. 实现生产环境的压测服务，模拟真实的生产峰值场景，以此来发现真实的线上瓶颈并实现监控分析。
2. 实现精准的容量规划，确保线上系统的正常运行，以及避免资源的铺张浪费。
3. 实现海量的并发请求，以次来模拟真实的用户峰值场景。
4. 实现压测流量和生产流量的隔离，避免对生产流量产生影响
5. 实现自动化压测，减少人工成本，并且提高压测频率，帮助快速发现问题。
6. (附加)实现对业务系统的大检查，提升业务系统的健壮性。

## 全链路压测方案

---

### 方案总览

![全链路压测方案](./链路压测/压测方案.png)

### 展开解读

- 背景
  - 说明压测的一个背景,一定要结合痛点来体现出好处和价值。
- 压测目标
  - 探知当前系统单接口的最大容量
  - 录制真实的线上流量，回放压测流量，充分利用当前的服务器资源，找到系统性能瓶颈。
  - 结合稳定性场景，做精准的容量规划，给后续的限流降级提供数据上的参考
  - 结合异常场景，实践并判断系统中的异常情况对线上产生的影响。
- 压测范围
  - 梳理出本次要压测的接口清单
- 启动准则
  - 确保旁路基础数据和生产一致，或按模型缩放
  - 确定预压测可以生成真实的业务
  - 准备环境
    - 基础静态数据压测验证通过
    - 各组件基础参数梳理并且配置正确
    - 压力机到位并部署完毕
    - 网络配置正确，连接通畅，可以满足压测需求
  - 压测计划&方案评审
  - 架构组、运维组、开发组、测试组相关保障人员到位
- 结束准则
  - 达到项目的目标容量水位
  - 关键性能瓶颈已解决
  - 确定精准的容量规划数据
  - 完成压测报告和性能调优报告
- 业务指标&性能指标
  - 目标tps是多少，实际tps是多少
- 架构图梳理
  - 技术组件&架构图
  - 逻辑架构图
  - 部署架构图
  - 硬件规格
- 工具准备
  - 流量回放工具
  - 流量存储工具
  - 监控工具
- 流量数据
  - 生产环境的真实数据分布
  - 流量一定要使用真实数据来覆盖真实用户
  - 流量数据一定要满足压测的可用性
- 系统改造
  - 链路打标 - 区分正常流量还是压测流量
  - 压测透传
    - trcae_id + span_id
    - 跨线程的透传
    - 跨服务的透传
- 压测隔离
  - 设置影子库
    - 比如mysql,正常叫mall,影子库叫mall_shadow
    - redis使用影子库，正常叫db1,影子库叫db5
    - rabbitMQ使用数据偏移，推送数据加上压测标记
- 日志隔离 - 将正常日志和压测日志从存储上区分开
- 第三方接口mock
  - 压测数据打入到mock server,不要导到第三方环境去

## 系统改造

---

### 一、梳理业务场景

架构梳理:

- 应用架构
- 技术架构
- 数据架构
- 安全架构

链路梳理:

- 业务接口梳理到表格
- APM工具查看链路信息
- 可以使用时序图梳理重要链路的详细信息

<font color=Coral size=4>技术架构图举例</font>

![技术架构图](./链路压测/e855108b770a14c819ac1af6a3c67bfa.jpg)

### 二、创建性能分析模型

![性能分析模型](./链路压测/59d9845e775edce954d26c7da0cb1944.jpg)

<font color="Coral" size="4">1、业务模型</font>

- 性能压测工具
  - 比较局限，适合简单的性能场景，覆盖面不全
- 流量回放工具
  - 等同于真实流量，但还需要额外处理token等工作，同时流量回放不代表就符合我们的目标模型
- 根据具体的目标业务场景调整流量分布
  - 按目标场景造流量数据，缺点是工作量较大

<font color="Coral" size="4">2、容量模型</font>

- 线性增加容量： 所有资源x2
- 递增容量，配合监控模型推出容量模型，比如tps增大一倍，只需要数据库容量x2

<font color="Coral" size="4">3、监控模型</font>

![监控模型](./链路压测/71e39cd615bb0ac4b322fe638e1918b5.jpg)

<font color="Coral" size="4">4、分析模型</font>

![分析模型](./链路压测/e47eea44ce87fcb1d94b38fe14fdd07b.jpg)

<font color="Coral" size="4">5、失效模型</font>

![失效模型](./链路压测/b1d44b128ac8b6f8820d05277a506f6c.jpg)

### 三、支持链路追踪和标记透传

![性能分析7步法](./链路压测/7f9f638aaf350eyy04efab3d0b85944b.jpg)

在上面的性能分析七步法中，分析架构图、拆分响应时间、全局监控分析、定向监控分析都需要用到链路追踪，可想它的重要性!

我们在做性能分析的时候，往往都是从全局监控到定向监控，从整体维度到局部维度来展示各项指标。比如我们先是关注接口的TPS、响应时间及错误数等metrics, 然后我们希望从链路追踪中，清晰地看到一个请求对应的每一段的耗时。当我们发现哪一段耗时比较长的时候，就可以到耗时长的那个组件上，根据定向监控的数据接着往下分析了。

同时我们对全链路标识透传也是有要求的，这个压测标识需要在链路追踪中被识别、记录、并传递，这样我们就能做到区分正常流量和压测流量了。总结一下，我们希望链路追踪达到的目标:

1. 请求链路追踪，快速定位问题，可以通过调用链结合业务日志快速定位错误信息；
2. 可视化UI: 细化服务各个阶段耗时并可视化展示，方便进行性能分析
3. 依赖优化: 统计各个调用组件的可用性、梳理服务依赖关系、可做到精准优化;
4. 数据分析，优化链路: 可以得到流量的请求路径，汇总分析各业务场景;
5. 区分流量: 可以识别、记录、传递压测标记，做到快速区分请求.

<font color=Coral size=4>链路追踪选型</font>

![链路追踪选型对比](./链路压测/9b22e625d8e20d06326b2593a85e62a5.jpg)

<font color=Coral size=4>标识透传方案</font>

- 跨线程间的透传
  - 数据上下文(Context)对象传递
  - 追加trcae_id和span信息
  - 追加流量标识，比如flag=yellow
- 跨服务间的透传
  - http请求: 追加kv字段到http header中
  - rpc请求: 追加kv字段到rpc metadata中

### 四、支持流量隔离

<font color="Coral" size="4">1、Mysql数据库隔离</font>

![mysql数据库隔离](https://static001.geekbang.org/resource/image/99/05/99ee4d4daa9fe5fe78d99c2d8fdc8105.jpg?wh=1920x1922)

<font color="Coral" size="4">2、Redis缓存隔离</font>

![redis缓存隔离](https://static001.geekbang.org/resource/image/82/91/8262b0af1bbf0135d5d36a51ab514491.jpg?wh=1512x635)

<font color="Coral" size="4">3、RabbitMQ消息队列隔离</font>

![rabbitMQ消息队列隔离](./链路压测/51c5cacb48d3f00edcf24ea389e0ca42.jpg)

<font color="Coral" size="4">4、日志文件隔离</font>

![日志文件隔离](./链路压测/ca406e7313aeb885b55acfcbbb2db632.jpg)

<font color="Coral" size="4">5、第三方接口隔离</font>

![第三方接口隔离](./链路压测/43e31e693dbf6dba460acaeedb03cace.jpg)

## 压测平台

---

### 压测平台架构图

![压测平台架构图](./链路压测/713cb37c39316091a6b6e987cb83c382.jpg)

### 对象存储

对象存储是一种海量、安全、低成本、高可靠的云存储服务，适合放任意类型的文件，还支持快速查询、上传下载等功能。

<font color="Coral" size="4">对象存储选型</font>

- 阿里云OSS
- 华为云OBS
- 腾讯云Chaos
- Ceph
- MinIO
- S3

### 流量回放工具

<font color="Coral" size="4">GoReplay录制原理</font>

![GoReplay原理图](./链路压测/069f66babeb0614f7dfa6f8e99b35bac.jpg)

<font color="Coral" size="4">GoReplay回放原理</font>

![GoReplay回放原理](./链路压测/fe26839250a99a3b2001a95a6cc7902b.jpg)

<font color="Coral" size="4">GoReplay动态数据关联</font>

需要关联的场景(主要解决会话的问题):

1. 数据是由服务端生成的
2. 数据在每一次请求的时候都是动态变化的
3. 数据在后续的请求中需要再发送出去

![GoReplay中间件&关联token的原理](./链路压测/c0b9bd3a17b2d34f0ec2d4e1ea5f0e00.jpg)

<font color="Coral" size="4">JMeter接口压测工具</font>

![JMeter接口压测工具](https://raw.githubusercontent.com/apache/jmeter/master/xdocs/images/screenshots/jmeter_screen.png)

### 压测管理器

<font color="Coral" size="4">XXL-Job架构图</font>

![xxl-job调度系统](./链路压测/c897f1feea1a144b751f456ea916efa0.png)

### 监控服务

<font color="Coral" size="4">全局监控分析</font>

- 操作系统监控分析决策树:

![操作系统监控分析决策树](./链路压测/2ff99beac609743a0a10ae6d4c80cdec.jpg)

- 数据库监控分析决策树
  
![数据库监控分析决策树](./链路压测/9d5d5a569bd00f92b21543e05c0f8584.jpg)

- 缓存监控分析决策树

![缓存监控分析决策树](./链路压测/24551ab2df5bf316b7a44fcccd732731.jpg)

- 消息队列监控分析决策树

![消息队列监控分析决策树](./链路压测/0222226751fc36fed83a07f01yyyyf24.jpg)

<font color="Coral" size="4">定向监控分析</font>

- 业务埋点： 埋点日志信息，统计接口成功或失败，路径或参数等基础属性。
- 聚合分析： 对埋点日志聚合统计，形成业务监控指标，比如失败比例，p99、p90等等。

## 性能场景

---

### 基准场景

- 目标是把接口都调优到最好的状态
- 这个时候不管业务模型的，主要是为了排查基础问题
  - 配合全局监控，调优基础性能。比如调整组件的资源配置、增加节点，最大化利用资源
- 这里的接口需要是原子类的接口

### 预压测场景

- 预压测场景和容量场景没什么区别，只是压力线程少一点而已
- 主要验证场景设置、参数化数据、网络环境、硬件环境等内容

### 容量场景

- 直接上压力数据，观察和预压测场景下的tps数据对比，查看全局监控分析，如果出现问题则先分析解决问题
- 如果tps没有达到我们预期的目标，可以在分析一下还有没有可以优化的点
  - 查看链路追踪，观察阻塞点
- 达到了预期tps，这个时候继续乘胜追击，分析一下各种指标看看时候还有继续优化的空间。
- 还有一个场景没验证，那就是正常流量和压测流量分流的场景
  - 验证流量是否正确分流到正常库和影子库。
  - 继续监控性能影响

### 稳定性场景

前置:

- 检查磁盘空间是不是足够
- 检查系统状态是不是良好
- 检查系统状态数据要不要重置
- 协调各部门做好准备

稳定性场景的两个关键指标:

- 稳定性运行时长
- 稳定性要用多大压力运行

### 异常场景

基准、容量、稳定性场景可以说明一个系统在正常运行时的性能，异常场景是说明到底应该如何设计才能做到全面覆盖。

故障模拟:

- 业务故障: 模拟方法执行时间长、内存溢出等故障
- 容器故障: 模拟CPU、内存等故障
- 中间件故障: 模拟数据库、缓存等中间件故障
- 硬件故障: 模拟磁盘损坏等
- 虚拟机故障
- 虚拟网络故障:
- 网络故障: 模拟延迟、丢包、抖动、重复包等
  - 模拟工具： ChaosMesh

## 结果&报告输出

---

### 系统容量评估

- TPC-A评估 - 对借记卡在局域网和广域网中的性能进行基准评估，增加了对ACID的要求
- TPC-B评估 - 使用和TPC-A相同的事务类型，但是取消了TPC-A中的网络和用户交互组件，剩下的是一个批处理事务基准
- TPC-C评估 - 使用的是商品批发销售公司的模型。主要是用了新订单、支付操作、发货、订单状态查询、库存查询这5个事务来执行并发。测试的结果主要有两个指标，也就是每分钟事务数(tpmC)和性价比(Price)
- TPC-E评估 - 使用的是证券交易所的业务模型，它模拟了12种事务类型，包括交易查询事务、交易执行事务等。

重点说明TPC-C:

![Untitled](./链路压测/Untitled.png)

- 日均请求量: 后台请求数
- 请求峰值系数: 这个值从历史经验数据中得来，像有些银行就是2-3之间
- 请求复杂度: 这里需要换算一下，看看一个请求约为多少个TPC-C的标准请求
- 预留扩展:  以用户数增长、请求量增长来预估系统处理能力的增长。没有固定值，像银行系统有个3-5倍已经挺高的。
- 系统最佳利用率： 通常定义在60%-80%左右，没有严格的规定

**排队论容量评估**

排队论： 研究系统随机聚散现象和随机服务系统工作过程的数学理论和方法，又称随机系统理论，运筹学的一个分支。

### 磁盘容量评估

日志：一般是循环的，有生命周期的；可以根据文件个数、文件大小、保存时间等进行清理规则设置，所以磁盘容量相对容易计算。

数据库容量:

$$
磁盘容量 = 原始磁盘容量 + \displaystyle\sum_{
\begin{subarray}{l}
   r=1
\end{subarray}}^{单表}(记录长度 * 记录数 * 保存期限 ) * 数据库膨胀因子 * 备份因子
$$

- 数据库膨胀因子: 根据具体的业务量进行评估，不同的业务模型，数据库的膨胀速度会有很大差别，而且不同的表的膨胀因子也不一样。
- 备份因子: 数据库最怕丢失数据，所以备份是必须的，很多重要的系统常常会设置三个备份，分别在本地机房、本城机房、远程机房

### 网络容量评估

$$
上行带宽 = 最大TPS * 每秒上行数据大小
$$

$$
下行带宽 = 最大TPS * 每秒下行数据大小
$$

### 压测报告

- 性能方案 - 实施前
- 调优报告  - 实施中
- 性能报告 - 实施后

要点：

- 报告中需要给出明确的通过或不通过的结论，另外还要给出清晰的生产配置建议。
- 必须明确说明项目所使用的硬件、软件、数据、压力策略、监控策略等内容
- 整理过程中的调优手段和策略，给到一线的运维人员进行系统参数调优
- 详细的数据报告罗列出来，提供给开发人员参考
